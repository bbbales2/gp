---
title: "R Notebook"
output: html_notebook
---

```{r}
library(deSolve)
Lorenz <- function(t, state, parameters) {
  with(as.list(c(state, parameters)),{
    # rate of change
    dx <- sigma*(y-x)
    dy <- x*(rho-z) - y
    dz <- x*y - beta*z

    # return the rate of change
    list(c(dx, dy, dz))
  })
}
  
parameters <- c(sigma = 10, beta = 8/3, rho = 28)
initial_state <- c(x = -8, y = 7, z = 27)
dt <- 0.1
times <- seq(0, 1, by = dt)

df <- ode(y = initial_state, times = times, func = Lorenz, parms = parameters) %>%
  as.data.frame %>% as_tibble# %>%
  #mutate(dxdt = c(NA,diff(x)/dt),
         #dydt = c(NA,diff(y)/dt),
         #dzdt = c(NA,diff(z)/dt))
```

```{r}
df %>% ggplot(aes(time, z)) + geom_line() + geom_point()
X <- model.matrix(dzdt ~ .^3, data = select(df, -time, -dxdt, -dydt))
lm(dzdt ~ ., data = mutate(as_tibble(X), dzdt = df$dzdt[2:(nrow(X)+1)]))
```

```{r, message = FALSE}
library(rstan)
sdata <- list(N = nrow(df), t = df$time, y = df$z)
fit <- stan("models/gp_posterior_pred.stan", data = sdata, chains = 4, iter = 2000, cores = 4)
```

```{r}
sy <- extract(fit, pars = c("rho", "alpha", "sigma"))

get_single_sample <- function(i) c(rho_y = sy$rho[i], alpha_y = sy$alpha[i], sigma_y = sy$sigma[i])
s_list <- map(1:100, get_single_sample)
#sample_derivs(sy[[1]], df$z, df$time)
single_post_pred <- sample_process(s_list[[1]], df$z, df$time, seq(0, 1, 0.005))
sing <- tibble(s = single_post_pred) %>% mutate(t = seq(0, 1, 0.005))
df %>% ggplot(aes(time, z)) + geom_line() + geom_point() + geom_line(aes(t,s), color = "red", data = sing)

gp_post_pred <- lapply(s_list, sample_process, ynoise = df$z, ti = df$time, t_star = seq(0, 1, 0.005))
names(gp_post_pred) <- (seq(1:length(gp_post_pred)))
gp_post_pred_tib <- gp_post_pred %>% as_tibble %>% mutate(time = seq(0, 1, 0.005)) %>% gather(sample_n, val, -time)

df_true <- ode(y = initial_state, times = seq(0, 1, by = 0.01), func = Lorenz, parms = parameters) %>%
  as.data.frame %>% as_tibble %>%
  mutate(dxdt = c(NA,diff(x)/dt),
         dydt = c(NA,diff(y)/dt),
         dzdt = c(NA,diff(z)/dt))

gp_post_pred_tib %>%
  ggplot(aes(time, val, group = sample_n)) +
  geom_line(alpha = 0.05) +
  geom_line(aes(time, z, group = NULL), color = "red",data = df_true) +
  geom_point(aes(time, z, group = NULL), color = "green",data = df)
```




